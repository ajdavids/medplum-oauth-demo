<!DOCTYPE html>
<html>

<head>
  <title>Medplum OAuth Demo</title>
</head>

<body>
  <script>

    window.addEventListener('load', async () => {
      // First, get the code from the query string params
      const code = new URLSearchParams(window.location.search).get('code');

      // Build the form data
      const body = new URLSearchParams();
      body.set('grant_type', 'authorization_code');
      body.set('client_id', '8bb0d37a-bed4-47d2-b317-05192b1f651b');
      body.set('code', code);

      // Exchange the authorization code for an access token
      const response = await fetch('https://api.medplum.com/oauth2/token', { method: 'POST', body }).then(res => res.json());
      console.log('response', response);

      document.getElementById('projectName').innerText = response.project.display;

      // Now we have an access token and can call the API
      const accessToken = response.access_token;

      // We can call the "/userinfo" to get current user details
      const userInfo = await fetch('https://api.medplum.com/oauth2/userinfo', {
        credentials: 'include',
        headers: {
          'Authorization': 'Bearer ' + accessToken,
        }
      }).then(res => res.json());
      console.log('userInfo', userInfo);
      document.getElementById('userId').innerText = `User ID: ${userInfo.sub}`;

      // We can search for FHIR resources
      const searchResult = await fetch('https://api.medplum.com/fhir/R4/Practitioner', {
        credentials: 'include',
        headers: {
          'Authorization': 'Bearer ' + accessToken,
        }
      }).then(res => res.json());
      console.log('searchResult', searchResult);
      innerHTML = searchResult.entry.forEach(
        (entry) => {
          const item = document.createElement('li');
          const name = entry.resource.name[0];
          item.innerText = `Practitioner: ${name.given[0]} ${name.family}`;
          document.getElementById('practictioners').appendChild(item);
        }
      );
    });


  </script>

  <h1 id="projectName"></h1>
  <p id="userId"></p>
  <ul id="practictioners"></ul>

</body>

</html>